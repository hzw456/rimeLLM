# Design: AI Clipboard 架构设计

## 系统架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                      AI Clipboard                           │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  Rime       │  │  用户配置    │  │  策略引擎           │  │
│  │  集成层     │  │  界面       │  │  (Strategy Engine)  │  │
│  └──────┬──────┘  └─────────────┘  └──────────┬──────────┘  │
│         │                                      │             │
│         ▼                                      ▼             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              核心处理框架 (Core Framework)           │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │    │
│  │  │  事件系统   │  │  配置管理   │  │  AI Provider│ │    │
│  │  │(Event Bus)  │  │(Config Mgr) │  │  Factory   │ │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘ │    │
│  └─────────────────────────────────────────────────────┘    │
│                            │                                 │
│                            ▼                                 │
│  ┌─────────────────────────────────────────────────────┐    │
│  │           AI 模型层 (AI Model Layer)                 │    │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌───────────┐ │    │
│  │  │ OpenAI  │ │ Claude  │ │ 本地模型│ │ 自定义    │ │    │
│  │  └─────────┘ └─────────┘ └─────────┘ └───────────┘ │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件设计

### 1. Rime 集成层 (Rime Integration Layer)

**职责**：
- 与 Rime 输入法框架通信
- 捕获用户输入事件和上下文
- 将优化建议注入到输入流程

**技术方案**：
- 使用 Rime 的 WebSocket API 或插件机制
- 实现一个轻量级的客户端库
- 支持 macOS 平台（Rime 在 macOS 上的实现）

**关键接口**：
```typescript
interface RimeIntegration {
  onInput(callback: (context: InputContext) => void): void;
  applySuggestion(suggestion: Suggestion): Promise<void>;
  getCurrentContext(): InputContext;
}
```

### 2. 事件系统 (Event System)

**职责**：
- 解耦输入捕获和处理流程
- 支持异步处理
- 提供扩展点

**设计模式**：
- 发布/订阅模式
- 支持优先级和拦截器

### 3. AI Provider 抽象层

**职责**：
- 统一不同 AI 模型的接口
- 支持模型切换和负载均衡
- 处理认证和重试

**接口设计**：
```typescript
interface AIProvider {
  process(request: AIRequest): Promise<AIResponse>;
  getCapabilities(): ProviderCapabilities;
  healthCheck(): Promise<boolean>;
}
```

### 4. 策略引擎 (Strategy Engine)

**职责**：
- 根据输入场景选择合适的处理策略
- 管理策略优先级和规则
- 支持用户自定义规则

**策略分类**：
- `CorrectionStrategy` - 文本纠错
- `ExpansionStrategy` - 文本扩写
- `TranslationStrategy` - 翻译
- `SummarizationStrategy` - 摘要

## 数据流设计

```
用户输入 → Rime捕获 → 事件发布 → 策略匹配 → AI处理 → 建议生成 → Rime注入 → 用户确认 → 应用
```

## 配置管理

**配置项**：
- AI 模型选择
- API Keys
- 策略规则
- 界面设置
- 性能参数

**存储方式**：
- 本地配置文件（JSON/YAML）
- 支持环境变量覆盖

## 性能考量

1. **延迟控制**
   - AI 请求超时：3s
   - 整体处理延迟：< 500ms
   - 使用流式响应减少感知延迟

2. **缓存策略**
   - 相似输入缓存
   - 常用短语缓存
   - 缓存过期策略

3. **并发处理**
   - 支持并行 AI 请求
   - 使用连接池

## 安全考虑

1. API Keys 安全存储
2. 输入内容不持久化（除非用户明确配置）
3. 本地处理优先，减少数据传输

## 扩展性设计

1. **插件机制**
   - 支持自定义处理器
   - 支持自定义策略

2. **多模型支持**
   - 统一 Provider 接口
   - 动态模型切换

## 待定决策

1. **通信协议**：Rime 集成使用 WebSocket 还是本地 socket？
2. **配置格式**：JSON 还是 YAML？
3. **部署方式**：独立应用还是 Rime 插件？
